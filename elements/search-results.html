<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/polymer-ui-menu-button/polymer-ui-menu-button.html">
<link rel="import" href="../components/polymer-ui-icon-button/polymer-ui-icon-button.html">
<link rel="import" href="../components/polymer-media-query/polymer-media-query.html">
<link rel="import" href="data-search.html">
<link rel="import" href="search-searchresult.html">

<polymer-element name="search-results" noscript attributes="purchases">
  <template>
    <polymer-ui-menu-button selected="0" selected="0" on-click="{{changeSort}}" icon="sort" selected="0" style="float:left;margin:12px;">
      <polymer-ui-menu-item id="menuItemSortByName" icon="up" label="Sort by Name" theme="polymer-ui-light-theme" field="name"></polymer-ui-menu-item>
      <polymer-ui-menu-item id="menuItemSortByScientificName" icon="up" label="Sort by Scientific Name" theme="polymer-ui-light-theme" field="scientificName"></polymer-ui-menu-item>
      <polymer-ui-menu-item id="menuItemSortByPrice" icon="up" label="Sort by Price" theme="polymer-ui-light-theme" field="price"></polymer-ui-menu-item>
    </polymer-ui-menu-button>
      
    <polymer-ui-icon-button icon="refresh" style="float:right;margin:12px" on-click="{{refresh}}"></polymer-ui-icon-button>
    <polymer-ui-icon-button icon="maximize" style="float:right;margin:12px" on-click="{{toggleSize}}"></polymer-ui-icon-button>
    <h2 style="margin-left:20px;">Search Results</h2>    
	
    <template if="{{searchResults==null || searchResults.length==0}}">
      <template if="{{pendingQuery}}">
	<div class="panel go">
	  Searching.
	</div>
      </template>
      <template if="{{!pendingQuery}}">
	<div class="panel warning">
	  <h2 style="margin-top:0px;">No search results!</h2>
	  No species were found that are suitable for your setup.
  <!--	Factors
	  <ul>
	    
	  </ul>-->
	</div>
      </template>    
    </template>
    <template if="{{searchResults!=null && searchResults.length>0}}">
      <template repeat="{{searchResults}}">
	<search-searchresult species="{{}}" on-add="{{addItem}}" maximize="{{maximize}}"></search-searchresult>
      </template>
      <template if="{{pendingQuery}}">
	<div class="polymer-ui-dark-theme" style="width:100%;padding:10px;">
	  Loading...
	</div>
      </template>
      <template if="{{lastResult}}">
	<div style="width:100%;height:{{titlebarBelow ? 60 : 5}}px;background-color:black"></div>
      </template>
    </template>

    <data-search id="searchQuery" on-polymer-response="{{loadSearchResults}}"></data-search>
    <polymer-media-query query="max-width: 800px" queryMatches="{{titlebarBelow}}"></polymer-media-query>    
  </template>
  <script>
    Polymer('search-results', {
      maximize: true,
      toggleSize: function(){
	console.log('maximize');
	this.maximize = true;
      },
      skip: 0,
      countPerPage: 0,
      lastResult: false,
      pendingQuery: false,
      maximize: false,
      sortField: 'name',
      sortDesc: false,
      changeSort: function(e) {
	//console.log("change");
	if(!this.pendingQuery){
	  var menuItem = e.impl.originalTarget.offsetParent;
	  var id = menuItem.id;
	  var field = menuItem.getAttribute('field');
	  if(field != null){
	    if(field === this.sortField){
	      //change sort order
	      if(this.$[id].icon == 'up'){
		this.$[id].icon = 'down';
	      }else{
		this.$[id].icon = 'up';
	      }   
	    }
	    this.sortField = field;
	    this.sortDesc = (this.$[id].icon == 'down');
	    this.refresh();
	  }
	}
      },
      refresh: function(){
	if(!this.pendingQuery){
	  console.log('refresh');
	  this.searchResults = null;
	  this.lastResult = false;
	  this.skip = 0;
	  this.go();
	}
      },
      go: function(){
	console.log('go ' + this.pendingQuery + "," + this.lastResult);
	if(this.pendingQuery==false && this.lastResult==false){
	  document.body.style.cursor = 'progress';	
	  this.pendingQuery = true;
	  
	  console.log('GO: skip ' + this.skip + ', limit ' + this.countPerPage + ', sort ' + this.sortField);
	  
	  //construct search params
	  //this.$.searchQuery.name = '';
	  //this.$.searchQuery.current = [];
	  //this.$.searchQuery.tanksize = 0;
	  //this.$.searchQuery.budget = 0;
	  this.$.searchQuery.skip = this.skip;
	  this.$.searchQuery.limit = this.countPerPage;
	  this.$.searchQuery.sort = this.sortField;
	  this.$.searchQuery.desc = this.sortDesc;
	  this.$.searchQuery.go();
	}
      },
      loadSearchResults: function(e){
	console.log('loadSearchResults');
	document.body.style.cursor = 'default';      
	var r = e.detail;
	console.log('loadSearchResults ' + r.length);
	if(r.length == 0){
	  this.lastResult = true;
	}else{
	  if(this.searchResults==undefined){
	    this.searchResults = r;
	  }else{
	    console.log('prepush');
	    console.log(this.searchResults.length);
	    //for(var i=0;i<r.length;i++){
	    //  this.searchResults.push(r[i]);
	    //}
	    Array.prototype.push.apply(this.searchResults, r);
	    console.log(this.searchResults.length);
	    console.log('postpush'); 
	  }
	  this.skip += r.length;
	}

	if(document.body.scrollHeight < window.innerHeight){
	  document.body.style.overflowY = "scroll";
	}
	this.pendingQuery = false;
      },
      attached: function(){
	var self = this;
	window.onscroll = function(ev) {
	    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
	      console.log('bottom');
	      self.go();
	    }
	};
	var resultHeight = 70;
	this.countPerPage = Math.ceil(window.innerHeight / resultHeight);
	//window.onresize = function(ev) {
	//  this.countPerPage = document.body.offsetHeight / resultHeight;
	//};      
	this.go();
      },
      addItem: function(e){
	console.log(this.purchases);
	if(this.purchases==null){
	  this.purchases = [e.detail];
	}else{
	  this.purchases.push(e.detail); 
	}
      }
    });
  </script>    
</polymer-element>