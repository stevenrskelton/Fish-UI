<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/polymer-ui-toolbar/polymer-ui-toolbar.html">
<link rel="import" href="../components/polymer-ui-icon-button/polymer-ui-icon-button.html">
<link rel="import" href="../components/polymer-ui-icon/polymer-ui-icon.html">
<link rel="import" href="../components/polymer-localstorage/polymer-localstorage.html">

<link rel="import" href="current-search.html">
<link rel="import" href="current-item.html">
    
<polymer-element name="current-index" noscript>
  <template>
    <current-search id="currentSearchModal" class="dialog" on-add="{{addItem}}" selectedItems="{{currentItems}}"></current-search>
  
    <polymer-ui-toolbar theme="polymer-ui-dark-theme" class="align-center polymer-ui-dark-theme flexbox">
    
      <polymer-flex-layout align="center" style="display: none;">
      </polymer-flex-layout>

      <polymer-media-query query="max-width: 800px">
      </polymer-media-query>
    
      <polymer-ui-icon-button icon="trash" class="polymer-ui-dark-theme" on-click="{{trash}}">
      </polymer-ui-icon-button>
      <div flex>What is your Current Livestock?</div>
      
      
      <polymer-ui-toolbar responsive="" class="align-center polymer-ui-dark-theme flexbox" style="text-align:center" flex="">
      
	<polymer-flex-layout align="center" style="display: none;">
	</polymer-flex-layout>
    
	<polymer-media-query query="max-width: 800px">
	</polymer-media-query>
	
	<form class="navbar-form navbar-left" role="search" style="width:600px;margin-left:auto;margin-right:auto;padding:0 10px;">
	  <polymer-flex-layout></polymer-flex-layout>
	  <input type="text" class="form-control input-lg" placeholder="Species or Common Name" flex style="margin-right:10px" onfocus="this.select()" id="searchText">
	  <button type="button" class="btn btn-primary btn-lg" on-click="{{search}}"><polymer-ui-icon icon="search"></polymer-ui-icon> Search</button>
	</form>

      </polymer-ui-toolbar>   
      
      <button type="button" class="btn btn-primary btn-lg" style="margin-right:10px" on-click="{{save}}">Next <polymer-ui-icon icon="shortcut"></polymer-ui-icon></button>
    </polymer-ui-toolbar>

    <template repeat="{{c in currentItems}}" id="currentItemsTemplate">
      <current-item species="{{c.species}}" name="{{c.name}}" src="{{c.src}}" number="{{c.number}}" on-remove="{{removeItem}}"></currentItem>
    </template>

    <polymer-localstorage id="currentItemsStorage" name="currentItems" value="{{currentItems}}" autoSaveDisabled></polymer-localstorage>
  </template>
  <script>
    Polymer('current-index',{
      search: function search(){
	var searchText = document.getElementById('searchText').value;
	if(searchText == ''){
	  alert('Please select a species to search for.');
	}else{
	  var modal = document.getElementById('currentSearchModal');
	  modal.search = searchText;
	  modal.selectedItems = this.currentItems;
	  modal.toggle('hi');
	}
      },
      addItem: function(e){
	console.log(this.currentItems);
	this.currentItems.push(e.detail); 
      },
      removeItem: function(e){
	var newArray = [];
	var species = e.detail;
	var c = this.currentItems;
	for(i = 0; i < c.length; i++){
	  if(c[i].species != species) newArray.push(c[i]);
	}
	this.currentItems = newArray;
      },
      ready: function(){
	this.currentItems = this.currentItems || [];
      },
      save: function(){
	var currentItemNodes = this.$.currentItemsTemplate.parentNode.querySelectorAll('current-item');
	for(i = 0; i < currentItemNodes.length; i++){
	  console.log(currentItemNodes[i].number);
	  if(currentItemNodes[i].number == null || currentItemNodes[i].number == ''){
	    alert('Please enter the number of [' + currentItemNodes[i].species + '] specimen, or remove the species from the list.');
	    currentItemNodes[i].focus();
	    return;
	  }
	}
	this.$.currentItemsStorage.save();
	document.location.href = 'search.html';
      },
      trash: function(){
	if(confirm('Do you want clear all your selections and start a new tank?')){
	  this.currentItems = [];
	  this.$.currentItemsStorage.save();
	  document.location.href='index.html'
	}
      }
    });
  </script>    
</polymer-element>